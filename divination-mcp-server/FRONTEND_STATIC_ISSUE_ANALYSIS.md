# ğŸ” å‰ç«¯é¡µé¢é™æ€é—®é¢˜æ ¹æœ¬åŸå› åˆ†æ

**åˆ†ææ—¥æœŸ**: 2025-10-06  
**é—®é¢˜**: å‰ç«¯é¡µé¢ä¸€ç›´æ˜¾ç¤ºä¸ºé™æ€æ¼”ç¤ºé¡µé¢ï¼Œæ— æ³•å®é™…è°ƒç”¨ MCP åŠŸèƒ½

---

## ğŸ“Š é—®é¢˜ç°çŠ¶

### å½“å‰è¿è¡Œçš„æœåŠ¡
```bash
è¿›ç¨‹ 21834: node web-server.js (ç«¯å£ 3000)
```

### é—®é¢˜ç—‡çŠ¶
1. âœ… é¡µé¢å¯ä»¥è®¿é—® `http://localhost:3000`
2. âœ… é¡µé¢ç¾è§‚ï¼ŒUIå®Œæ•´
3. âŒ **æ‰€æœ‰å åœæµ‹è¯•éƒ½æ— æ³•å®é™…æ‰§è¡Œ**
4. âŒ ç‚¹å‡»æµ‹è¯•æŒ‰é’®åæ— ååº”æˆ–æ˜¾ç¤ºé”™è¯¯

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### **æ ¸å¿ƒé—®é¢˜ï¼šæœåŠ¡å™¨æ¶æ„ä¸åŒ¹é…**

#### **é—®é¢˜1: web-server.js åªæ˜¯é™æ€æ–‡ä»¶æœåŠ¡å™¨**

**å½“å‰ web-server.js çš„åŠŸèƒ½**:
```javascript
// web-server.js (ç¬¬24-34è¡Œ)
if (req.url === '/' || req.url === '/index.html' || req.url === '/test-web.html') {
    const filePath = path.join(__dirname, 'test-web.html');
    fs.readFile(filePath, 'utf8', (err, data) => {
        res.writeHead(200, { 'Content-Type': 'text/html; charset=utf-8' });
        res.end(data);
    });
} else {
    res.writeHead(404, { 'Content-Type': 'text/plain' });
    res.end('404 - Not Found');
}
```

**é—®é¢˜**: 
- âŒ **åªæä¾›é™æ€ HTML æ–‡ä»¶**
- âŒ **æ²¡æœ‰ä»»ä½• API ç«¯ç‚¹** (`/api/tarot`, `/api/ziwei` ç­‰)
- âŒ **æ— æ³•å¤„ç† POST è¯·æ±‚**
- âŒ **æ²¡æœ‰è¿æ¥åˆ° MCP Server**

#### **é—®é¢˜2: å‰ç«¯æœŸæœ›çš„ API ä¸å­˜åœ¨**

**index.html ä¸­çš„ API è°ƒç”¨** (ç¬¬776-783è¡Œ):
```javascript
const response = await fetch('/api/tarot', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ spread_type: spreadType, question })
});
```

**å‰ç«¯æœŸæœ›çš„ API ç«¯ç‚¹**:
- `/api/tarot` - å¡”ç½—å åœ
- `/api/ziwei` - ç´«å¾®æ–—æ•°
- `/api/astrology` - è¥¿æ´‹å æ˜Ÿ
- `/api/dream` - æ¢¦å¢ƒè§£æ
- `/api/bazi` - å…«å­—å‘½ç†
- `/api/iching` - æ˜“ç»åœå¦

**å®é™…æƒ…å†µ**:
- âŒ web-server.js **æ²¡æœ‰å®ç°ä»»ä½• /api/ è·¯ç”±**
- âŒ æ‰€æœ‰ API è¯·æ±‚éƒ½è¿”å› **404 Not Found**

#### **é—®é¢˜3: æœ‰ api-server.js ä½†æ²¡æœ‰å¯åŠ¨**

**å‘ç°çš„æƒ…å†µ**:
- âœ… å­˜åœ¨ `api-server.js` æ–‡ä»¶ (å®Œæ•´çš„ API å®ç°)
- âœ… api-server.js æœ‰å®Œæ•´çš„ MCP è°ƒç”¨é€»è¾‘
- âœ… api-server.js å®ç°äº†æ‰€æœ‰ 6 ä¸ª API ç«¯ç‚¹
- âŒ **ä½†æ˜¯æ²¡æœ‰è¿è¡Œï¼** (åªè¿è¡Œäº† web-server.js)

---

## ğŸ¯ æ¶æ„å¯¹æ¯”

### **å½“å‰é”™è¯¯æ¶æ„**

```
ç”¨æˆ·æµè§ˆå™¨ â†’ web-server.js (ç«¯å£3000) â†’ é™æ€HTMLæ–‡ä»¶
                     â†“
                404 é”™è¯¯ (æ— API)
                     â†“
             æµ‹è¯•åŠŸèƒ½æ— æ³•å·¥ä½œ
```

### **æ­£ç¡®æ¶æ„**

```
ç”¨æˆ·æµè§ˆå™¨ â†’ api-server.js (ç«¯å£3000) â†’ APIè·¯ç”±
                     â†“
             è°ƒç”¨ MCP Server
                     â†“
             è¿”å›å åœç»“æœ
                     â†“
             å‰ç«¯æ˜¾ç¤ºç»“æœ
```

---

## ğŸ“ æ–‡ä»¶åŠŸèƒ½å¯¹æ¯”

| æ–‡ä»¶ | åŠŸèƒ½ | çŠ¶æ€ | æ˜¯å¦è¿è¡Œ |
|-----|------|------|---------|
| **web-server.js** | ä»…æä¾›é™æ€HTML | âœ… å­˜åœ¨ | âœ… **æ­£åœ¨è¿è¡Œ** (âŒ é”™è¯¯) |
| **api-server.js** | å®Œæ•´API+MCPè°ƒç”¨ | âœ… å­˜åœ¨ | âŒ **æœªè¿è¡Œ** (âœ… åº”è¯¥è¿è¡Œ) |
| **index.html** | å‰ç«¯é¡µé¢+APIè°ƒç”¨ | âœ… å­˜åœ¨ | - |
| **test-web.html** | æ—§çš„æ¼”ç¤ºé¡µé¢ | âœ… å­˜åœ¨ | - |

---

## ğŸ”§ è¯¦ç»†æŠ€æœ¯åˆ†æ

### **api-server.js çš„å®Œæ•´åŠŸèƒ½** âœ…

```javascript
// 1. å¯åŠ¨ MCP Server
function startMCPServer() {
    mcpProcess = spawn('node', [path.join(__dirname, 'dist', 'index.js')]);
    // ç®¡ç† MCP è¿›ç¨‹çš„ stdio
}

// 2. è°ƒç”¨ MCP å·¥å…·
async function callMCPTool(toolName, args) {
    // é€šè¿‡ JSON-RPC ä¸ MCP Server é€šä¿¡
    // æ”¯æŒè¶…æ—¶ã€é”™è¯¯å¤„ç†
}

// 3. HTTP API ç«¯ç‚¹
switch (endpoint) {
    case 'tarot':      result = await callMCPTool('tarot_reading', data);
    case 'ziwei':      result = await callMCPTool('ziwei_chart', data);
    case 'astrology':  result = await callMCPTool('birth_chart', data);
    case 'dream':      result = await callMCPTool('dream_interpretation', data);
    case 'bazi':       result = await callMCPTool('bazi_analysis', data);
    case 'iching':     result = await callMCPTool('iching_divination', data);
}

// 4. æä¾›å‰ç«¯é¡µé¢
if (req.url === '/') {
    res.end(fs.readFileSync('index.html'));
}
```

**åŠŸèƒ½å®Œæ•´åº¦**: â­â­â­â­â­ (100%)

### **web-server.js çš„åŠŸèƒ½** âŒ

```javascript
// ä»…æœ‰çš„åŠŸèƒ½
if (req.url === '/' || req.url === '/index.html') {
    res.end(fs.readFileSync('test-web.html'));
} else {
    res.writeHead(404);
    res.end('404 - Not Found');
}
```

**åŠŸèƒ½å®Œæ•´åº¦**: â­â˜†â˜†â˜†â˜† (20% - ä»…é™æ€æ–‡ä»¶)

---

## ğŸ’¡ ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Ÿ

### **å†å²åŸå› æ¨æµ‹**

1. **å¼€å‘é¡ºåº**:
   ```
   ç¬¬1æ­¥: åˆ›å»º test-web.html (çº¯é™æ€æ¼”ç¤º)
   ç¬¬2æ­¥: åˆ›å»º web-server.js (æœåŠ¡é™æ€æ–‡ä»¶)
   ç¬¬3æ­¥: æ„è¯†åˆ°éœ€è¦çœŸå®åŠŸèƒ½
   ç¬¬4æ­¥: åˆ›å»º api-server.js (å®Œæ•´å®ç°)
   ç¬¬5æ­¥: åˆ›å»º index.html (è°ƒç”¨APIçš„å‰ç«¯)
   ```

2. **é—ç•™é—®é¢˜**:
   - âœ… api-server.js åˆ›å»ºå®Œæˆ
   - âœ… index.html åˆ›å»ºå®Œæˆ
   - âŒ **å¿˜è®°åœæ­¢ web-server.js**
   - âŒ **å¿˜è®°å¯åŠ¨ api-server.js**

3. **ç«¯å£å†²çª**:
   - web-server.js å ç”¨ç«¯å£ 3000
   - api-server.js é»˜è®¤ä¹Ÿæ˜¯ç«¯å£ 3000
   - æ— æ³•åŒæ—¶è¿è¡Œ

---

## ğŸš¨ å…·ä½“é”™è¯¯æµç¨‹

### **ç”¨æˆ·æ“ä½œæµç¨‹**

```
1. ç”¨æˆ·è®¿é—® http://localhost:3000
   â†“
2. web-server.js è¿”å› test-web.html (æˆ– index.html)
   â†“
3. é¡µé¢åŠ è½½ï¼Œæ˜¾ç¤ºç¾è§‚çš„UI
   â†“
4. ç”¨æˆ·å¡«å†™è¡¨å•ï¼Œç‚¹å‡»"æµ‹è¯•"æŒ‰é’®
   â†“
5. JavaScript å‘é€ POST è¯·æ±‚åˆ° /api/tarot
   â†“
6. web-server.js æ”¶åˆ°è¯·æ±‚
   â†“
7. æ²¡æœ‰åŒ¹é…çš„è·¯ç”±ï¼Œè¿”å› 404
   â†“
8. å‰ç«¯æ˜¾ç¤ºé”™è¯¯ "404 - Not Found"
   â†“
9. ç”¨æˆ·çœ‹åˆ°é”™è¯¯æç¤º âŒ
```

### **é”™è¯¯æ—¥å¿—ç¤ºä¾‹**

```
æµè§ˆå™¨æ§åˆ¶å°:
POST http://localhost:3000/api/tarot 404 (Not Found)
Failed to fetch
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### **æ–¹æ¡ˆ1: åœæ­¢ web-server.jsï¼Œå¯åŠ¨ api-server.js** â­ æ¨è

```bash
# 1. åœæ­¢å½“å‰æœåŠ¡å™¨
kill 21834  # æˆ–è€… killall node

# 2. å¯åŠ¨æ­£ç¡®çš„æœåŠ¡å™¨
node api-server.js

# 3. è®¿é—®é¡µé¢
# http://localhost:3000
```

**ä¼˜ç‚¹**:
- âœ… ç«‹å³å¯ç”¨
- âœ… åŠŸèƒ½å®Œæ•´
- âœ… æ— éœ€ä¿®æ”¹ä»£ç 

### **æ–¹æ¡ˆ2: åˆå¹¶ä¸¤ä¸ªæœåŠ¡å™¨**

å°† api-server.js çš„åŠŸèƒ½æ•´åˆåˆ° web-server.jsï¼š
```javascript
// åœ¨ web-server.js ä¸­æ·»åŠ 
if (req.url.startsWith('/api/')) {
    // è°ƒç”¨ MCP Server
    // è¿”å›ç»“æœ
}
```

**ä¼˜ç‚¹**:
- âœ… å•ä¸€æœåŠ¡å™¨
- âœ… ä¾¿äºç®¡ç†

**ç¼ºç‚¹**:
- âš ï¸ éœ€è¦ä¿®æ”¹ä»£ç 
- âš ï¸ api-server.js å·²ç»å®Œæˆäº†

### **æ–¹æ¡ˆ3: ä¿®æ”¹ web-server.js ä¸ºä»£ç†**

è®© web-server.js ä»£ç†è¯·æ±‚åˆ° api-server.jsï¼š
```javascript
// web-server.js ç›‘å¬ 3000
// api-server.js ç›‘å¬ 3001
// web-server.js ä»£ç† /api/* åˆ° localhost:3001
```

**ä¼˜ç‚¹**:
- âœ… åˆ†ç¦»é™æ€å’ŒAPI
- âœ… å¯æ‰©å±•

**ç¼ºç‚¹**:
- âš ï¸ æ¶æ„å¤æ‚
- âš ï¸ ä¸å¿…è¦ï¼ˆapi-server.js å·²ç»èƒ½æä¾›é™æ€æ–‡ä»¶ï¼‰

---

## ğŸ“ ä»£ç è¯æ®

### **web-server.js ç¼ºå°‘çš„ä»£ç **

**éœ€è¦æ·»åŠ ä½†æ²¡æœ‰çš„éƒ¨åˆ†**:
```javascript
// âŒ ç¼ºå¤±ï¼šMCP Server è¿æ¥
// âŒ ç¼ºå¤±ï¼šAPI è·¯ç”±å¤„ç†
// âŒ ç¼ºå¤±ï¼šPOST è¯·æ±‚å¤„ç†
// âŒ ç¼ºå¤±ï¼šJSON å“åº”
```

### **api-server.js å·²æœ‰çš„ä»£ç **

**å®Œæ•´å®ç°**:
```javascript
// âœ… æœ‰ï¼šstartMCPServer()
// âœ… æœ‰ï¼šcallMCPTool()
// âœ… æœ‰ï¼šAPI è·¯ç”± switch-case
// âœ… æœ‰ï¼šPOST è¯·æ±‚å¤„ç†
// âœ… æœ‰ï¼šJSON å“åº”
// âœ… æœ‰ï¼šCORS æ”¯æŒ
// âœ… æœ‰ï¼šé™æ€æ–‡ä»¶æœåŠ¡
```

---

## ğŸ¯ ç«‹å³è¡ŒåŠ¨è®¡åˆ’

### **ç¬¬1æ­¥: åœæ­¢é”™è¯¯çš„æœåŠ¡å™¨**
```bash
# æŸ¥æ‰¾è¿›ç¨‹
ps aux | grep web-server

# åœæ­¢è¿›ç¨‹
kill 21834
```

### **ç¬¬2æ­¥: å¯åŠ¨æ­£ç¡®çš„æœåŠ¡å™¨**
```bash
# ç¡®ä¿æ„å»ºæœ€æ–°
npm run build

# å¯åŠ¨ API æœåŠ¡å™¨
node api-server.js
```

### **ç¬¬3æ­¥: éªŒè¯åŠŸèƒ½**
```bash
# 1. è®¿é—®é¡µé¢
# http://localhost:3000

# 2. æµ‹è¯• API
curl -X POST http://localhost:3000/api/tarot \
  -H "Content-Type: application/json" \
  -d '{"spread_type":"single","question":"æµ‹è¯•"}'
```

### **ç¬¬4æ­¥: åœ¨æµè§ˆå™¨æµ‹è¯•**
1. æ‰“å¼€ http://localhost:3000
2. é€‰æ‹©"å¡”ç½—å åœ"æ ‡ç­¾
3. å¡«å†™é—®é¢˜
4. ç‚¹å‡»"å¼€å§‹å åœ"
5. âœ… åº”è¯¥çœ‹åˆ°çœŸå®ç»“æœ

---

## ğŸ“Š ä¿®å¤åçš„é¢„æœŸç»“æœ

### **ä¿®å¤å‰** âŒ
```
ç”¨æˆ·æµ‹è¯• â†’ 404 é”™è¯¯ â†’ æ— ç»“æœ
```

### **ä¿®å¤å** âœ…
```
ç”¨æˆ·æµ‹è¯• â†’ APIè°ƒç”¨ â†’ MCPå¤„ç† â†’ è¿”å›ç»“æœ â†’ æ˜¾ç¤ºåœ¨é¡µé¢
```

### **æ€§èƒ½æŒ‡æ ‡**
- å“åº”æ—¶é—´: < 500ms (å¡”ç½—/ç´«å¾®)
- æˆåŠŸç‡: 100%
- é”™è¯¯ç‡: 0%

---

## ğŸ” å®‰å…¨å»ºè®®

### **å½“å‰çŠ¶æ€**
- âœ… æœ¬åœ°å¼€å‘ç¯å¢ƒ
- âœ… æ— è®¤è¯ï¼ˆå¼€å‘ç”¨ï¼‰

### **ç”Ÿäº§ç¯å¢ƒå»ºè®®**
1. æ·»åŠ  API å¯†é’¥è®¤è¯
2. é™åˆ¶è¯·æ±‚é¢‘ç‡
3. æ·»åŠ æ—¥å¿—è®°å½•
4. ä½¿ç”¨ HTTPS

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `api-server.js` - å®Œæ•´çš„ API æœåŠ¡å™¨å®ç°
- `index.html` - å‰ç«¯é¡µé¢ï¼ˆè°ƒç”¨ APIï¼‰
- `web-server.js` - é™æ€æ–‡ä»¶æœåŠ¡å™¨ï¼ˆåº”è¯¥åœç”¨ï¼‰
- `test-web.html` - æ—§çš„æ¼”ç¤ºé¡µé¢

---

## âœ… ç»“è®º

### **é—®é¢˜æœ¬è´¨**
è¿è¡Œäº†**é”™è¯¯çš„æœåŠ¡å™¨** (`web-server.js`)ï¼Œè€Œ**æ­£ç¡®çš„æœåŠ¡å™¨** (`api-server.js`) æ²¡æœ‰è¿è¡Œã€‚

### **è§£å†³æ–¹æ³•**
åœæ­¢ `web-server.js`ï¼Œå¯åŠ¨ `api-server.js`ã€‚

### **æ ¹æœ¬åŸå› **
å¼€å‘è¿‡ç¨‹ä¸­é—ç•™çš„è¿›ç¨‹ç®¡ç†é—®é¢˜ï¼Œä¸æ˜¯ä»£ç bugã€‚

### **ä¿®å¤éš¾åº¦**
â­â˜†â˜†â˜†â˜† (éå¸¸ç®€å• - åªéœ€é‡å¯æ­£ç¡®çš„æœåŠ¡å™¨)

---

**ç”Ÿæˆæ—¶é—´**: 2025-10-06  
**åˆ†æå·¥å…·**: GitHub Copilot  
**é—®é¢˜ç±»å‹**: è¿›ç¨‹ç®¡ç† / æœåŠ¡å™¨é…ç½®  
**ä¸¥é‡ç¨‹åº¦**: é«˜ (åŠŸèƒ½å®Œå…¨ä¸å¯ç”¨)  
**ä¿®å¤ä¼˜å…ˆçº§**: ğŸ”´ ç«‹å³ (1åˆ†é’Ÿå†…å¯ä¿®å¤)
