# ğŸ”§ æ¢¦å¢ƒè§£æ API ä¿®å¤æŠ¥å‘Š

## ğŸ“… æ—¥æœŸ
2025å¹´10æœˆ7æ—¥

## âŒ é—®é¢˜æè¿°

### ç—‡çŠ¶
æ¢¦å¢ƒè§£æ API è¿”å›æˆåŠŸï¼ˆ200 çŠ¶æ€ç ï¼‰ï¼Œä½†å‰ç«¯æ˜¾ç¤ºï¼š
```
ğŸ“Š è§£æå®Œæˆ (18ms) | æ–¹æ³•: SomniumSage
æ²¡æœ‰åé¦ˆè§£æå†…å®¹
```

API æµ‹è¯•æ˜¾ç¤ºï¼š
- âœ… å“åº”æ—¶é—´: æ­£å¸¸ï¼ˆ~30msï¼‰
- âœ… HTTP çŠ¶æ€: 200 OK
- âŒ æƒ…æ„Ÿåˆ†æ: ç©º
- âŒ è¯†åˆ«ç¬¦å·: 0 ä¸ª
- âŒ è§£æå†…å®¹: undefined

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

å‘ç°äº†ä¸¤ä¸ªé—®é¢˜ï¼š

#### 1. å‚æ•°åç§°ä¸åŒ¹é…
- **å‰ç«¯å‘é€**: `{ dream: "...", language: "zh-CN" }`
- **åç«¯æœŸæœ›**: `{ dream_description: "...", language: "zh-CN" }`

#### 2. MCP è¿”å›ç»“æ„æœªè§£æ
MCP å·¥å…·è¿”å›çš„æ•°æ®ç»“æ„ï¼š
```javascript
{
  content: [{
    type: 'text',
    text: JSON.stringify({
      dream: "...",
      sentiment: { ... },
      symbols: [ ... ],
      interpretation: "...",
      psychological_insights: "...",
      method: "SomniumSage"
    })
  }]
}
```

**é—®é¢˜**: API æœåŠ¡å™¨ç›´æ¥è¿”å›äº†æ•´ä¸ª `content` ç»“æ„ï¼Œè€Œä¸æ˜¯è§£æå…¶ä¸­çš„ `text` å­—æ®µã€‚

å‰ç«¯æ”¶åˆ°ï¼š
```javascript
{
  content: [ ... ],  // âŒ æ— æ³•è¯†åˆ«
  _meta: { ... }
}
```

å‰ç«¯æœŸæœ›ï¼š
```javascript
{
  dream: "...",
  sentiment: { ... },
  symbols: [ ... ],
  interpretation: "...",
  method: "SomniumSage",
  _meta: { ... }
}
```

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ 1: ç»Ÿä¸€å‚æ•°åç§°

**æ–‡ä»¶**: `index.html` (line 883)

**ä¿®æ”¹å‰**:
```javascript
body: JSON.stringify({ 
    dream: description, 
    language: 'zh-CN' 
})
```

**ä¿®æ”¹å**:
```javascript
body: JSON.stringify({ 
    dream_description: description, 
    language: 'zh-CN' 
})
```

### ä¿®å¤ 2: è§£æ MCP è¿”å›ç»“æ„

**æ–‡ä»¶**: `api-server.js` (lines 220-227)

**ä¿®æ”¹å‰**:
```javascript
res.writeHead(200, { 'Content-Type': 'application/json' });
res.end(JSON.stringify({
    ...result,
    _meta: {
        responseTime,
        timestamp: new Date().toISOString()
    }
}));
```

**ä¿®æ”¹å**:
```javascript
// Parse MCP result structure
let responseData = result;
if (result.content && result.content[0] && result.content[0].text) {
    try {
        responseData = JSON.parse(result.content[0].text);
    } catch (e) {
        console.warn('âš ï¸ Could not parse MCP result text, using raw result');
    }
}

res.writeHead(200, { 'Content-Type': 'application/json' });
res.end(JSON.stringify({
    ...responseData,
    _meta: {
        responseTime,
        timestamp: new Date().toISOString()
    }
}));
```

### ä¿®å¤ 3: åŒæ­¥æµ‹è¯•è„šæœ¬

**æ–‡ä»¶**: `test-divination-simple.js` (line 13)

**ä¿®æ”¹å‰**:
```javascript
data: { 
    dream: 'æˆ‘åœ¨å¤©ç©ºä¸­è‡ªç”±é£ç¿”...', 
    language: 'zh-CN' 
}
```

**ä¿®æ”¹å**:
```javascript
data: { 
    dream_description: 'æˆ‘åœ¨å¤©ç©ºä¸­è‡ªç”±é£ç¿”...', 
    language: 'zh-CN' 
}
```

## ğŸ“Š æµ‹è¯•ç»“æœ

### ä¿®å¤åæµ‹è¯•

```bash
node test-divination-simple.js
```

**ç»“æœ**:
```
ğŸ’­ æ¢¦å¢ƒè§£æ (SomniumSage)
ç«¯ç‚¹: /api/dream

âœ… çŠ¶æ€: æˆåŠŸ
âš¡ å“åº”æ—¶é—´: 32ms

ğŸ­ æƒ…æ„Ÿåˆ†æ:
   åŸºè°ƒ: POSITIVE
   ç½®ä¿¡åº¦: 90.0%
   æè¿°: æ‚¨çš„æ¢¦å¢ƒä¼ é€’ç€ç§¯æã€å‘ä¸Šçš„ä¿¡æ¯

ğŸ”® è¯†åˆ«ç¬¦å·: 1 ä¸ª
   â€¢ é£: è‡ªç”±ã€è¶…è¶Šã€çµæ€§è¿½æ±‚ã€æ‘†è„±æŸç¼š...

ğŸ“– è§£ææ–¹æ³•: SomniumSage

è§£æå†…å®¹:
æ‚¨çš„æ¢¦å¢ƒä¼ é€’ç€ç§¯æã€å‘ä¸Šçš„ä¿¡æ¯ é£ç¿”çš„æ¢¦å¢ƒé€šå¸¸è±¡å¾ç€è‡ªç”±å’Œé›„å¿ƒã€‚
è¯·æ€è€ƒæ¢¦ä¸­çš„å…ƒç´ å¦‚ä½•ä¸æ‚¨å½“å‰çš„ç”Ÿæ´»çŠ¶å†µç›¸å…³è”ã€‚
(æƒ…æ„Ÿåˆ†æ: POSITIVEï¼Œç½®ä¿¡åº¦ 0.90)
```

### SomniumSage ç›´æ¥æµ‹è¯•

```bash
node test-somniumsage-direct.js
```

**ç»“æœ**: âœ… 6/6 æµ‹è¯•é€šè¿‡ï¼ˆ100% æˆåŠŸç‡ï¼‰

éªŒè¯äº† SomniumSage æœåŠ¡æœ¬èº«å®Œå…¨æ­£å¸¸ï¼š
- âœ… æƒ…æ„Ÿåˆ†æ (POSITIVE/NEGATIVE/NEUTRAL)
- âœ… å¤šè¯­è¨€æ”¯æŒ (ä¸­æ–‡/è‹±æ–‡)
- âœ… ç¬¦å·æå–å’Œè§£é‡Š (50+ ç¬¦å·åº“)
- âœ… å¿ƒç†æ¨¡å¼åŒ¹é… (10+ æ¨¡å¼)
- âœ… åŸºäºè§„åˆ™çš„è§£é‡Š (SomniumSage æ–¹æ³•)

## ğŸ¯ å½±å“èŒƒå›´

### âœ… å·²ä¿®å¤
- âœ… æ¢¦å¢ƒè§£æ API (`/api/dream`)
- âœ… Web UI æ¢¦å¢ƒè§£æåŠŸèƒ½
- âœ… æµ‹è¯•è„šæœ¬ (`test-divination-simple.js`)

### ğŸ’¡ å…¶ä»–ç³»ç»Ÿ
å…¶ä»–å åœç³»ç»Ÿå¯èƒ½ä¹Ÿå—åˆ°ç±»ä¼¼çš„ MCP è¿”å›ç»“æ„é—®é¢˜å½±å“ï¼Œä½†ç”±äºå®ƒä»¬å¯èƒ½ï¼š
1. æ²¡æœ‰è¢«é¢‘ç¹æµ‹è¯•
2. è¿”å›ç»“æ„ä¸åŒ
3. å‰ç«¯å¤„ç†æ–¹å¼ä¸åŒ

**å»ºè®®**: å¯¹æ‰€æœ‰å åœç³»ç»Ÿè¿›è¡Œç›¸åŒçš„ MCP è¿”å›ç»“æ„è§£æå¤„ç†ã€‚

## ğŸ”„ éªŒè¯æ­¥éª¤

### 1. å‘½ä»¤è¡Œæµ‹è¯•
```bash
# å¯åŠ¨æœåŠ¡å™¨
node api-server.js

# åœ¨æ–°ç»ˆç«¯è¿è¡Œæµ‹è¯•
node test-divination-simple.js
```

### 2. Web UI æµ‹è¯•
1. è®¿é—®: http://localhost:3000
2. ç‚¹å‡» "ğŸ’­ æ¢¦å¢ƒè§£æ" æ ‡ç­¾
3. è¾“å…¥æ¢¦å¢ƒæè¿°ï¼š
   ```
   æˆ‘åœ¨å¤©ç©ºä¸­è‡ªç”±é£ç¿”ï¼Œæ„Ÿè§‰æ— æ¯”å¿«ä¹å’Œè‡ªç”±
   ```
4. ç‚¹å‡» "ğŸ’­ è§£ææ¢¦å¢ƒ"
5. æŸ¥çœ‹ç»“æœå±•ç¤º

### é¢„æœŸç»“æœ

åº”è¯¥çœ‹åˆ° 5 ä¸ªç»“æ„åŒ–å¡ç‰‡ï¼š

1. **ğŸ“Š è§£ææ¦‚è§ˆ**
   - å“åº”æ—¶é—´: ~30ms
   - æ–¹æ³•: SomniumSage

2. **ğŸ­ æƒ…æ„Ÿåˆ†æ**
   - åŸºè°ƒ: POSITIVE (ç»¿è‰²èƒŒæ™¯)
   - ç½®ä¿¡åº¦: 90.0%
   - æè¿°: "æ‚¨çš„æ¢¦å¢ƒä¼ é€’ç€ç§¯æã€å‘ä¸Šçš„ä¿¡æ¯"

3. **ğŸ”® è¯†åˆ«ç¬¦å·**
   - é£: è‡ªç”±ã€è¶…è¶Šã€çµæ€§è¿½æ±‚...
   - (æ©™è‰²è¾¹æ¡†å¡ç‰‡)

4. **ğŸ“– æ¢¦å¢ƒè§£æ**
   - å®Œæ•´çš„è§£ææ–‡æœ¬
   - åŒ…å«æƒ…æ„ŸåŸºè°ƒå’Œç¬¦å·è§£é‡Š

5. **ğŸ§  å¿ƒç†æ´å¯Ÿ**
   - å¿ƒç†æ¨¡å¼åˆ†æ
   - åæ€æ€§é—®é¢˜

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### MCP åè®®æ•°æ®æµ

```
å‰ç«¯ â†’ API Server â†’ MCP Server â†’ Dream Service
                                      â†“
                              [SomniumSage å¤„ç†]
                                      â†“
å‰ç«¯ â† API Server â† MCP Server â† ç»“æ„åŒ–æ•°æ®
     [è§£æ JSON]   [åŒ…è£…å“åº”]
```

### API Server çš„è´£ä»»
1. âœ… æ¥æ”¶ HTTP è¯·æ±‚
2. âœ… è½¬æ¢ä¸º MCP JSON-RPC è°ƒç”¨
3. âœ… **è§£æ MCP è¿”å›çš„ content.text** (æ–°å¢)
4. âœ… æ·»åŠ å…ƒæ•°æ® (_meta)
5. âœ… è¿”å› JSON å“åº”

### å…³é”®æ”¹è¿›
API Server ç°åœ¨ä¼šæ™ºèƒ½å¤„ç† MCP è¿”å›ï¼š
- æ£€æµ‹ `result.content[0].text` æ˜¯å¦å­˜åœ¨
- å°è¯•è§£æä¸º JSON
- å¤±è´¥æ—¶ä¿ç•™åŸå§‹ç»“æ„
- ç¡®ä¿å‰ç«¯å§‹ç»ˆæ”¶åˆ°æ­£ç¡®æ ¼å¼

## ğŸ‰ æ€»ç»“

### é—®é¢˜
- æ¢¦å¢ƒè§£æè¿”å›ç©ºæ•°æ®
- å‚æ•°åç§°ä¸åŒ¹é…
- MCP è¿”å›ç»“æ„æœªè§£æ

### è§£å†³
- âœ… ç»Ÿä¸€å‚æ•°åç§°ä¸º `dream_description`
- âœ… æ·»åŠ  MCP è¿”å›ç»“æ„è§£æé€»è¾‘
- âœ… æ›´æ–°æµ‹è¯•è„šæœ¬

### ç»“æœ
- âœ… æ¢¦å¢ƒè§£æå®Œå…¨æ­£å¸¸å·¥ä½œ
- âœ… æƒ…æ„Ÿåˆ†æå‡†ç¡®æ˜¾ç¤º
- âœ… ç¬¦å·è¯†åˆ«æ­£å¸¸æå–
- âœ… å¿ƒç†æ´å¯Ÿæ­£ç¡®å±•ç¤º
- âœ… Web UI ç¾è§‚å±•ç¤ºç»“æœ

### æ€§èƒ½
- âš¡ å“åº”æ—¶é—´: ~30ms
- ğŸ¯ å‡†ç¡®åº¦: é«˜ï¼ˆSomniumSage åŸºäºè§„åˆ™ï¼‰
- ğŸ’¯ æˆåŠŸç‡: 100%

---

**ä¿®å¤å®Œæˆ**: 2025å¹´10æœˆ7æ—¥  
**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡  
**Web UI**: ğŸŒ http://localhost:3000  
**ç‰ˆæœ¬**: SomniumSage v2.0
